<?php
$url = "https://raw.githubusercontent.com/winacti/lst/master/";
$archivo = "tempserial.temp";
$error = false;
$win10pro = "VzI2OU4tV0ZHV1gtWVZDOUItNEo2QzktVDgzR1g";
$win10home = "VFg5WEQtOThON1YtNldNUTYtQlg3RkctSDhROTksS1ROUFYtS1RSSzQtM1JSUjgtMzlYNlctVzQ0VDMsWVRNRzMtTjZES0MtREtCNzctN005R0gtOEhWWDcsNENQUkstTk0zSzMtWDZYWFEtUlhYODYtV1hDSFc";
//******************Funciones*****************
function color() {
	$p = "\e[";
	$f = ";40m";
	$color[0] = $p."0;30".$f; // Negro
	$color[1] = $p."1;30".$f; // Gris oscuro
	$color[2] = $p."0;31".$f; // Rojo
	$color[3] = $p."1;31".$f; // Rojo Claro
	$color[4] = $p."0;32".$f; // Verde
	$color[5] = $p."1;32".$f; // Verde Claro
	$color[6] = $p."0;33".$f; // Marron
	$color[7] = $p."1;33".$f; // Marillo
	$color[8] = $p."0;34".$f; // Azul
	$color[9] = $p."1;34".$f; // Azul Claro
	$color[10] = $p."0;35".$f; // Magenta
	$color[11] = $p."1;35".$f; // Magenta Claro
	$color[12] = $p."0;36".$f; // Cyan 
	$color[13] = $p."1;36".$f; // Cyan Claro
	$color[14] = $p."0;37".$f; // Gris claro
	$color[15] = $p."1;37".$f; // Blanco
	return $color;
}
function spaces($s,$total){
	for($n=1;$n<=$total;$n++) {
		$nc.=$s;	
	}
	return $nc;
}
function debase64($txt) {
	$txt = base64_decode($txt);
	$txt = explode(",", $txt);
	$num = rand(1,count($txt))-1;
	$key = $txt[$num];
	return $key;
}
function menuprincipal($nfp) {
	$color = color();
	$title = "Activador de licencias de ".$nfp;
	$opcion1 = "Buscar licencia preinstalada.";
	$opcion2 = "Introducir licencia.";
	$opcion3 = "Asignar licencia predefinida.";
	$opcion4 = "Buscar licencia en internet.";
	$longtitle = strlen($title);
	$res = bcdiv(100 - $longtitle - 2, '2', 0);;
	// limpiar pantalla
	echo chr(27).chr(91).'H'.chr(27).chr(91).'J';   //^[H^[J  
	echo $color[14].spaces("*", 100);
	echo "*".spaces(" ",98)."*";
	echo "*".spaces(" ",$res).$color[7].$title.$color[14].spaces(" ",$res)."*";
	echo "*".spaces(" ",98)."*";
	echo spaces("*", 100);
	echo "*".spaces(" ",98)."*";
	echo "*   ".$color[13]."1".$color[14]." - ".$opcion1.spaces(" ", 100-strlen($opcion1)-12)."   *";
	echo "*   ".$color[13]."2".$color[14]." - ".$opcion2.spaces(" ", 100-strlen($opcion2)-12)."   *";
	echo "*   ".$color[13]."3".$color[14]." - ".$opcion3.spaces(" ", 100-strlen($opcion3)-12)."   *";
	echo "*   ".$color[13]."4".$color[14]." - ".$opcion4.spaces(" ", 100-strlen($opcion4)-12)."   *";
	echo "*".spaces(" ",98)."*";
	echo spaces("*", 100)."\n\n";
	echo $color[15]."  Selecciona la opción que deseas realizar: ";
	$handle = fopen("php://stdin", "r");
	$vali = strtolower(trim(fgets($handle)));
	echo "\n\n";
	return strtolower($vali);
}
function online($url) {
	$color = color();
	$archivo_descargado = "filetemp.tmp";
	// Descargar archivo
	exec("curl -L ".$url." -o ".$archivo_descargado);

	// Comprobar si el archivo ha sido descargado
	if (file_exists($archivo_descargado)) {
		if (filesize($archivo_descargado)>1) {
			echo $color[12]."\nI: ".$color[4]."Archivo de licencias, descargado correctamente.\n".$color[14];
			$contenido = abrir($archivo_descargado);
			unlink($archivo_descargado);
			return $contenido;
		}else {
			echo $color[12]."\nI: ".$color[3]."Se produjo algún error y el archivo se descargó defectuoso.\n\n\n".$color[14];
		}
	}else {
		echo $color[12]."\nI: ".$color[3]."Se produjo algún error y el archivo no se descargó.\n\n\n".$color[14];
	}
}

function abrir($f){$t=null;$l=fopen($f,"r");while(!@feof($l)){$t.=@fgets($l,900);}fclose($l);return $t;}
function cerrar($r,$f){$fch=fopen($r,"w");fputs($fch,$f);fclose($fch);}
function extraer($a,$b,$c,$d) {	return substr($a,(strpos($a,$c,$b)+(strlen($c))),(strpos($a,$d,(strpos($a,$c,$b)+(strlen($c)))))-(strpos($a,$c,$b)+(strlen($c)))); }
//******************Fin de Funciones*****************
exec("mode con:cols=100 lines=30");
$color = color();
$tmpfile = "temp.tmp";
// Obtener nombre de distribución de windows 10
exec("wmic os get Caption /value > ".$tmpfile);
$bol =file_exists($tmpfile);
$nfp = null;
if ($bol) {
	$ftemp = abrir($tmpfile);
	unlink($tmpfile);
	$ftemp = trim(utf8_decode($ftemp));
	$flong = strpos($ftemp, "=");
	if ($flong>=10) {
		$w = $flong + 2;
		for($g=$w;$g<=strlen($ftemp);$g+=2) {
			$nfp = $nfp.substr($ftemp, $g, 1);
		}
	}
}
// Preguntar si buscar clave en el equipo
$node = false;

$vali=null;
while($node==false) {
	$vali = menuprincipal($nfp);
	if ($vali>=1 && $vali<=4) {
		$node= true;
	}
}

if($vali==1) {
	echo chr(27).chr(91).'H'.chr(27).chr(91).'J';   //^[H^[J  
	// Buscar key en bios
	echo $color[12]."\nI: ".$color[14]."Buscando clave de registro en el equipo..\n";
	exec("wmic path softwarelicensingservice get OA3xOriginalProductKey > ".$archivo);
	// Extraer la key del archivo y ponerla en formato legible
	$bol =file_exists($archivo);
	if ($bol) {
		$serialtemp = abrir($archivo);
		$serialtemp = trim(utf8_decode($serialtemp));
		$part = substr($serialtemp, 68);
		$lon = strlen($part);
		$nf=null;
		for ($n=0;$n<$lon;$n+=2) {
			$nf = $nf.substr($part, $n, 1);
		}
		// Borrar archivo temporal de la key
		unlink($archivo);
		//online($url);
		if (strlen($nf)>25) {
			// Mostrar key en pantalla
			echo $color[12]."I: ".$color[14]."El equipo esta registrado con la clave: ".$color[4].$nf.$color[14]."\n";
			exec("slmgr /ipk ".$nf);
			exec("slmgr /skms kms8.msguides.com");
			exec("slmgr /ato");
			exec("slmgr.vbs /xpr");
		}else {
			echo $color[12]."I: ".$color[3]."El equipo no tiene una clave de registro preinstalada.\n\n";
		$error=true;	
		}
	}else {
		echo $color[12]."I: ".$color[3]."El equipo no tiene una clave de registro preinstalada.\n\n";
		$error=true;
	}
}if ($vali=="2") {
	$error=true;
}
if($error) {
	echo $color[15]."  Introduce una clave de registro válida: ";
	$handle = fopen("php://stdin", "r");
	$key = trim(fgets($handle));
	exec("slmgr /ipk ".$key);
	exec("slmgr /skms kms8.msguides.com");
	exec("slmgr /ato");
	exec("slmgr.vbs /xpr");
}
$key = null;
// Aplicar licencias predefinidas
if($vali=="3") {
		if ($nfp=="Microsoft Windows 10 Pro") {	$key = debase64($win10pro);	}
		else if ($nfp=="Microsoft Windows Home") { $key = debase64($win10home);	}
}

// Buscar licencias online
if ($vali=="4") {
	if ($nfp=="Microsoft Windows 10 Pro") {	
		$text = online($url."pro.dat");
		$key = debase64($text);
	}else if ($nfp=="Microsoft Windows Home") {
		$text = online($url."home.dat");
		$key = debase64($text);
	}
}

if ($key!=null) {
	echo $color[12]."I: ".$color[14]."Instalando clave del producto..\n";
	exec("slmgr /ipk ".$key);
	echo $color[12]."I: ".$color[14]."Estableciendo servicio de Administracion de claves..\n";
	exec("slmgr /skms kms8.msguides.com");
	echo $color[12]."I: ".$color[14]."Activando ".$nfp."..\n";
	exec("slmgr /ato");
	echo $color[12]."I: ".$color[14]."Comprobando activación..\n";
	exec("slmgr.vbs /xpr");
}
sleep(3);
