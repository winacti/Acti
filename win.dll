<?php
$version = "1.0.3";
$url = "https://raw.githubusercontent.com/winacti/Acti/master/dat/";
$archivo = "tempserial.temp";
$error = false;
$wType1 = "Vks3SkctTlBIVE0tQzk3Sk0tOU1QR1QtM1Y2NlQ";
$wType2 = "VFg5WEQtOThON1YtNldNUTYtQlg3RkctSDhROTksS1ROUFYtS1RSSzQtM1JSUjgtMzlYNlctVzQ0VDMsWVRNRzMtTjZES0MtREtCNzctN005R0gtOEhWWDcsNENQUkstTk0zSzMtWDZYWFEtUlhYODYtV1hDSFc";
echo "1";
//******************Funciones*****************
function is_connected() {
	exec("mode con:cols=100 lines=30");
	$connected = false;
	$connected = @fopen("http://www.google.com:80/","r");
	if($connected) { return true; }
	else { return false; }
} 
function get_url($url, $useragent='cURL', $headers=false, $follow_redirects=true, $debug=false) {
    // initialise the CURL library
    $ch = curl_init();
	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    // specify the URL to be retrieved
    curl_setopt($ch, CURLOPT_URL,$url);

    // we want to get the contents of the URL and store it in a variable
    curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);

    // specify the useragent: this is a required courtesy to site owners
    curl_setopt($ch, CURLOPT_USERAGENT, $useragent);

    // ignore SSL errors
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

    // return headers as requested
    if ($headers==true){
        curl_setopt($ch, CURLOPT_HEADER,1);
    }

    // only return headers
    if ($headers=='headers only') {
        curl_setopt($ch, CURLOPT_NOBODY ,1);
    }

    // follow redirects - note this is disabled by default in most PHP installs from 4.4.4 up
    if ($follow_redirects==true) {
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1); 
    }

    // if debugging, return an array with CURL's debug info and the URL contents
    if ($debug==true) {
        $result['contents']=curl_exec($ch);
        $result['info']=curl_getinfo($ch);
    }

    // otherwise just return the contents as a variable
    else $result=curl_exec($ch);

    // free resources
    curl_close($ch);

    // send back the data
    return $result;
}
function checkWin(){
	$tmpfile = "temp.tmp";
	// Obtener nombre de distribución de windows 10
	exec("wmic os get Caption /value > ".$tmpfile);
	$bol =file_exists($tmpfile);
	$nfp = null;
	if ($bol) {
		$ftemp = abrir($tmpfile);
		unlink($tmpfile);
		$ftemp = trim(utf8_decode($ftemp));
		$flong = strpos($ftemp, "=");
		if ($flong>=10) {
			$w = $flong + 2;
			for($g=$w;$g<=strlen($ftemp);$g+=2) {
				$nfp = $nfp.substr($ftemp, $g, 1);
			}
		}
	}
	// Asignar código
	if (($nfp=="Microsoft Windows 10 Pro") || ($nfp=="Microsoft Windows 10 Enterprise")) {
		$typeversion = 0; // Pro
	}else if ($nfp=="Microsoft Windows Home") {
		$typeversion = 1; // Home
	}
	return $nfp;
}
function checkUpdate($version) {
	// Comprobar version
	echo chr(27).chr(91).'H'.chr(27).chr(91).'J';   //^[H^[J 
	prin("Buscando actualizaciones..", 14);
	$vers = "update.tmp";
	$url = "https://raw.githubusercontent.com/winacti/Acti/master/update/version.dat";
	$update = trim(get_url($url));
	$quest = "  ¿deseas descargar la versión ".$update."? (S/N): ";	
	// Comprobar si existe actualizacion
	if (version_compare($version, $update, '<')) {
		$fin=false;
		prin("Se ha detectado una actualiación.\n", 14);
		while($fin==false) {
			echo $quest."                               \n";
			echo "\033[1A";
			echo $quest;
			$handle = fopen("php://stdin", "r");
			$input = strtolower(trim(fgets($handle)));
			if ($input=="s" || $input=="n") { 
				break;
			}else {
				"\n";
				echo "\033[1A";
			}
		}
		if ($input=="s") {
			donwloadUpdate($update);
		}
	}
}
function donwloadUpdate($update) {
	echo "\n";
	$path = '%USERPROFILE%\Downloads\\';
	$file = "Activador-v".$update.".exe";
	$url = "https://raw.githubusercontent.com/winacti/Acti/master/update/".$file;
	prin("Descargando actualización en el directorio Descargas.", 14);
	exec("curl -s -L ".$url." -o ".$file);
	if (file_exists($file) && filesize($file)>1) {
		prin("Actualización descargada correctamente", 14);
		exec("move ".$file." ".$path.$file);
	}else {
		prin("El archivo de actualización no se ha podido descargar.", 3);
	}
	sleep(5);	
}
function color() {
	$p = "\e[";
	$f = ";40m";
	$color[0] = $p."0;30".$f; // Negro
	$color[1] = $p."1;30".$f; // Gris oscuro
	$color[2] = $p."0;31".$f; // Rojo
	$color[3] = $p."1;31".$f; // Rojo Claro
	$color[4] = $p."0;32".$f; // Verde
	$color[5] = $p."1;32".$f; // Verde Claro
	$color[6] = $p."0;33".$f; // Marron
	$color[7] = $p."1;33".$f; // Marillo
	$color[8] = $p."0;34".$f; // Azul
	$color[9] = $p."1;34".$f; // Azul Claro
	$color[10] = $p."0;35".$f; // Magenta
	$color[11] = $p."1;35".$f; // Magenta Claro
	$color[12] = $p."0;36".$f; // Cyan 
	$color[13] = $p."1;36".$f; // Cyan Claro
	$color[14] = $p."0;37".$f; // Gris claro
	$color[15] = $p."1;37".$f; // Blanco
	return $color;
}
function spaces($s,$total){
	for($n=1;$n<=$total;$n++) {
		$nc.=$s;	
	}
	return $nc;
}
function debase64($txt) {
	$txt = base64_decode($txt);
	$txt = explode(",", $txt);
	$num = rand(1,count($txt))-1;
	$key = $txt[$num];
	return $key;
}
function prin($text, $clr) {
	$color = color();
	echo $color[12]."I: ".$color[$clr].$text."\n";
}

function menuprincipal($nfp, $internet) {
	$color = color();
	$title = "Activador de licencias de ".$nfp;
	$opcion1 = "Buscar licencia preinstalada.";
	$opcion2 = "Introducir licencia.";
	$opcion3 = "Asignar licencia predefinida.";
	$opcion4 = "Buscar licencia en internet.";
	$longtitle = strlen($title);
	$res = bcdiv(100 - $longtitle - 2, '2', 0);
	$ttutal = $res+$res+$longtitle+2;
	// limpiar pantalla
	echo chr(27).chr(91).'H'.chr(27).chr(91).'J';   //^[H^[J  
	echo $color[14].spaces("*", 100);
	echo "*".spaces(" ",98)."*";
	if ($ttutal<100) {
		echo "*".spaces(" ",$res).$color[7].$title.$color[14].spaces(" ",$res)." *";
	}else {
		echo "*".spaces(" ",$res).$color[7].$title.$color[14].spaces(" ",$res)."*";
	}
	echo "*".spaces(" ",98)."*";
	echo spaces("*", 100);
	echo "*".spaces(" ",98)."*";
	echo "*   ".$color[13]."1".$color[14]." - ".$opcion1.spaces(" ", 100-strlen($opcion1)-12)."   *";
	echo "*   ".$color[13]."2".$color[14]." - ".$opcion2.spaces(" ", 100-strlen($opcion2)-12)."   *";
	echo "*   ".$color[13]."3".$color[14]." - ".$opcion3.spaces(" ", 100-strlen($opcion3)-12)."   *";
	if ($internet) { echo "*   ".$color[13]."4".$color[14]." - ".$opcion4.spaces(" ", 100-strlen($opcion4)-12)."   *"; }
	echo "*".spaces(" ",98)."*";
	echo spaces("*", 100)."\n\n";
	echo $color[15]."  Selecciona la opción que deseas realizar: ";
	$handle = fopen("php://stdin", "r");
	$vali = strtolower(trim(fgets($handle)));
	echo "\n\n";
	return strtolower($vali);
}
function countdown($seconds) { 
	$color = color();
	for ($i = $seconds; $i >= 1; $i--) {
		if ($i>3) { $cc = $color[7]; }
		else if ($i<=3) { $cc = $color[13]; }
		echo $color[12]."I: ".$color[14]."La ventana se cerrará en ".$cc.$i.$color[14]." segundos..\n";
		sleep(1);
		echo "\033[1A";
	}
}
function online($url) {
	$color = color();
	$archivo_descargado = "filetemp.tmp";
	// Descargar archivo
	prin("Comenzando la descarga del archivo de licencias..", 14);
	exec("curl -s -L ".$url." -o ".$archivo_descargado);
	sleep(1);
	// Comprobar si el archivo ha sido descargado
	if (file_exists($archivo_descargado) && filesize($archivo_descargado)>1) {
		prin("Archivo de licencias, descargado correctamente.", 14);
		$contenido = abrir($archivo_descargado);
		unlink($archivo_descargado);
		return $contenido;
	}else {
		echo $color[12]."\nI: ".$color[3]."Se produjo algún error y el archivo no se descargó.\n\n\n".$color[14];
	}
}
function validar($key, $nfp) {
	$color = color();
	$tmp = "temp.tmp";
	//Primer paso de activación
	prin("Instalando clave del producto..", 14);
	exec("cscript C:\Windows\System32\slmgr.vbs -ipk ".$key." > ".$tmp);
	$txt = abrir($tmp);
	unlink($tmp);
	$found = @strpos($txt, "correctamente.");
	if ($found>10) { prin("La clave se instaló correctamente.", 4); }
	else { prin("Ocurrió un problema instalando la clave.", 3); }
	
	// Segundo paso de activación
	prin("Estableciendo servicio de Administracion de claves..", 14);
	exec("cscript C:\Windows\System32\slmgr.vbs -skms kms8.msguides.com > ".$tmp);
	$txt = abrir($tmp);
	unlink($tmp);
	$found = strpos($txt, "correctamente");
	if ($found>10) { prin("El Servicio de administración de claves se estableció correctamente.", 4); }
	else { prin("Ocurrió un problema instalando el servicio de administración de claves.", 3); }
	
	// Tercer paso de activación
	prin("Activando ".$nfp."..", "14");
	exec("cscript C:\Windows\System32\slmgr.vbs -ato > ".$tmp);
	$txt = abrir($tmp);
	unlink($tmp);
	$found = strpos($txt, "correctamente");
	if ($found>10) { prin("El producto se activó correctamente.", 4); }
	else { prin("Ocurrió un problema al activar el producto.", 3); }
	
	// Cuarto paso de activación
	prin("Comprobando activación..", "14");
	exec("cscript C:\Windows\System32\slmgr.vbs -xpr > ".$tmp);
	$txt = abrir($tmp);
	unlink($tmp);
	$found = strpos($txt, "expirar");
	$found2 = strpos($txt, "activado de forma permanente");
	if ($found>10) { 
		$txt2 = substr($txt, $found+12);
		echo $color[12]."I: ".$color[4]."La fecha de expiración del producto es: ".$color[15].$txt2."\n".$color[14];
	}
	else if ($found2>10) { 
		echo $color[12]."I: ".$color[4]."El equipo está activado de forma permamente.";
	}
	else { prin("Ocurrió un problema instalando el servicio de administración de claves.", 3); }
}
function abrir($f){$t=null;$l=fopen($f,"r");while(!@feof($l)){$t.=@fgets($l,900);}fclose($l);return $t;}
function cerrar($r,$f){$fch=fopen($r,"w");fputs($fch,$f);fclose($fch);}
function extraer($a,$b,$c,$d) {	return substr($a,(strpos($a,$c,$b)+(strlen($c))),(strpos($a,$d,(strpos($a,$c,$b)+(strlen($c)))))-(strpos($a,$c,$b)+(strlen($c)))); }
//******************Fin de Funciones*****************
// Comprobar actualizaciones
$color = color();
$internet = is_connected();
$current = "";
if (!$internet) { 
	prin("No se detectó conexión a Intentet.\n", 3);
	sleep(3);
}else {
	checkUpdate($version);
}
$typeversion = checkWin();
$node = false;
$vali=null;
while($node==false) {
	$vali = menuprincipal($nfp, $internet);
	if ($vali>=1 && $vali<=4) {
		$node= true;
	}
}

if($vali==1) {
	//echo chr(27).chr(91).'H'.chr(27).chr(91).'J';   //^[H^[J  
	// Buscar key en bios
	 prin("Buscando clave de registro en el equipo..", 14);
	exec("wmic path softwarelicensingservice get OA3xOriginalProductKey > ".$archivo);
	// Extraer la key del archivo y ponerla en formato legible
	$bol =file_exists($archivo);
	if ($bol) {
		$serialtemp = abrir($archivo);
		$serialtemp = trim(utf8_decode($serialtemp));
		$part = substr($serialtemp, 68);
		$lon = strlen($part);
		$nf=null;
		for ($n=0;$n<$lon;$n+=2) {
			$nf = $nf.substr($part, $n, 1);
		}
		// Borrar archivo temporal de la key
		unlink($archivo);
		//online($url);
		if (strlen($nf)>25) {
			// Mostrar key en pantalla
			prin("El equipo esta registrado con la clave: ".$color[4].$nf.$color[14], 14);
			validar($nf, $nfp);
		}else {
			prin("El equipo no tiene una clave de registro preinstalada.\n", 3);
		$error=true;	
		}
	}else {
		prin("El equipo no tiene una clave de registro preinstalada.\n", 3);
		$error=true;
	}
}if ($vali=="2") {
	$error=true;
}
$key = null;
if($error) {
	echo $color[15]."  Introduce una clave de registro válida: ";
	$handle = fopen("php://stdin", "r");
	$key = trim(fgets($handle));
}
// Aplicar licencias predefinidas
if($vali=="3") {
		if ($typeversion==0) {$key = debase64($wType1);	}
		else if ($typeversion==1) { $key = debase64($wType2);	}
}

// Buscar licencias online
if ($vali=="4") {
	if ($typeversion==0) {	
		$text = online($url."pro.dat");
		$key = debase64($text);
	}else if ($typeversion==1) {
		$text = online($url."home.dat");
		$key = debase64($text);
	}
}

if ($key!=null) {
	validar($key, $nfp);
}
if ($key==$null) {
	prin("No se ha introducido una licencia.", 3);
}
echo "\n";

// Cuenta atrás para finalizar programa de activacion
countdown(10);
?>
